name: Subdomain Enumeration CI
 
on:
  workflow_dispatch:

jobs:
  subdomain-enumeration:
    runs-on: ubuntu-latest
    env:
      TARGET_DOMAIN: ${{ secrets.TARGET_DOMAIN }} 
    
    steps:
      - uses: actions/checkout@v2
       
      # Amass, Sublist3r, censys-subdomain-finder, jq, findomain, subfinder, httpx, resolvers.txt, massdns
      - name: Install Dependencies
        run: |
          sudo snap install amass
          git clone https://github.com/aboul3la/Sublist3r.git
          pip install -r Sublist3r/requirements.txt
          git clone https://github.com/christophetd/censys-subdomain-finder.git
          pip install -r censys-subdomain-finder/requirements.txt
          wget --quiet https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
          mv jq-linux64 jq && chmod +x jq
          wget --quiet https://github.com/Findomain/Findomain/releases/download/2.1.5/findomain-linux
          mv findomain-linux findomain && chmod +x findomain
          wget --quiet https://github.com/projectdiscovery/subfinder/releases/download/v2.4.5/subfinder_2.4.5_linux_amd64.tar.gz
          tar -xzvf subfinder_2.4.5_linux_amd64.tar.gz
          wget --quiet https://raw.githubusercontent.com/ValluvarSploit/Resolver/main/resolvers.txt
          wget --quiet https://github.com/projectdiscovery/httpx/releases/download/v1.0.3/httpx_1.0.3_linux_amd64.tar.gz
          tar -xvf httpx_1.0.3_linux_amd64.tar.gz
          git clone https://github.com/blechschmidt/massdns.git
          cd massdns/ && make
      - name: Remove & Create Output Files
        run: |
         rm subdomains-tools-output.txt live-httpx-subdomains-output.txt live-ips-output.txt live-hosts-output.txt
         touch 
      - name: Sublist3r
        run: |
         python Sublist3r/sublist3r.py -d "$TARGET_DOMAIN" -p 80,443,21,22 -o subdomains-tools-output.txt >/dev/null
      - name: Amass
        run: |
         amass enum -passive -d "$TARGET_DOMAIN" >> subdomains-tools-output.txt
      - name: Censys
        env:
         CENSYS_API_ID: ${{ secrets.CENSYS_API_ID }}
         CENSYS_API_SECRET: ${{ secrets.CENSYS_API_SECRET }}
        run: |
         python censys-subdomain-finder/censys_subdomain_finder.py --censys-api-id "$CENSYS_API_ID" --censys-api-secret "$CENSYS_API_SECRET" "$TARGET_DOMAIN" | cut -d ' ' -f4 >> subdomains-tools-output.txt
      - name: Security Trails
        env:
         SECURITY_TRAILS_API_KEY: ${{ secrets.SECURITY_TRAILS_API_KEY }}
        run: |
         curl -s --request GET --url https://api.securitytrails.com/v1/domain/"$TARGET_DOMAIN"/subdomains?apikey="$SECURITY_TRAILS_API_KEY" | ./jq '.subdomains[]' | sed 's/\"//g' >test.txt 2>/dev/null && sed "s/$/."$TARGET_DOMAIN"/" test.txt | sed 's/ //g' && rm test.txt >> subdomains-tools-output.txt
      - name: Certspotter
        run: |
         curl -s https://certspotter.com/api/v0/certs\?domain\="$TARGET_DOMAIN" | ./jq '.[].dns_names[]' | sed 's/\"//g' | sed 's/\*\.//g' | grep "$TARGET_DOMAIN" >> subdomains-tools-output.txt
      - name: RapidDNS
        run: |
         curl -s "https://rapiddns.io/subdomain/"$TARGET_DOMAIN"?full=1" | grep -oP '_blank">\K[^<]*' | grep -v http >> subdomains-tools-output.txt
      - name: Crt.sh
        run: |
         curl https://crt.sh/?q=%."$TARGET_DOMAIN" | grep "$TARGET_DOMAIN" | cut -d '>' -f2 | cut -d '<' -f1 | grep -v " " | uniq >> subdomains-tools-output.txt
      - name: Findomain
        run: |
         ./findomain -t "$TARGET_DOMAIN" -q >> subdomains-tools-output.txt
      - name: Subfinder
        run: |
         ./subfinder -d "$TARGET_DOMAIN" --silent >> subdomains-tools-output.txt
      - name: Unique subdomains
        run: |
         mv subdomains-tools-output.txt temp_file1.txt
         cat temp_file1.txt | sed 's/\*\.//g' > temp_file2.txt
         sort -u temp_file2.txt -o temp_file2.txt
         grep -vf ignore-hosts.txt temp_file2.txt > subdomains-tools-output.txt
      - name: Create Wordlists
        run: |
         sed "s/$/.$TARGET_DOMAIN/" wordlists/subdomain-wordlists.txt > custom-wordlist.txt
         cat subdomains-tools-output.txt custom-wordlist.txt > massdns-input.txt
      - name: DNS Resolver-MassDNS
        run: |
         ./massdns/bin/massdns -r resolvers.txt -t A -o S -w massdns-output.txt massdns-input.txt
         cat massdns-output.txt | awk '{print $1}' | sed 's/.$//' | sort -u > live-hosts-output.txt
         cat massdns-output.txt | awk '{print $3}' | sort -u | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" > live-ips-output.txt
      - name: HTTP/HTTPS Resolver-httpx
        run: |
         ./httpx -l live-hosts-output.txt -o live-httpx-subdomains-output.txt
      - name: Remove Dependencies
        run: |
         rm -rf Sublist3r/ censys-subdomain-finder/ massdns/
         rm jq findomain LICENSE.md README.md subfinder subfinder_2.4.5_linux_amd64.tar.gz resolvers.txt custom-wordlist.txt massdns-input.txt httpx httpx_1.0.3_linux_amd64.tar.gz
      - name: Display Output Files
        run: |
         echo "subdomains-tools-output.txt"
         cat subdomains-tools-output.txt | head
         echo "---------------------------------------------------"
         echo "live-httpx-subdomains-output.txt"
         cat live-httpx-subdomains-output.txt | head
         echo "---------------------------------------------------"
         cat massdns-input.txt | head
         echo "---------------------------------------------------"
         echo "massdns-output.txt"
         cat massdns-output.txt | head
         echo "---------------------------------------------------"
         echo "live-hosts-output.txt"
         cat live-hosts-output.txt | head
         echo "----------------------------------------------------"
         echo "live-ips-output.txt"
         cat live-ips-output.txt | head
      - name: Commit Output Files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add subdomains-tools-output.txt live-httpx-subdomains-output.txt live-hosts-output.txt live-ips-output.txt 
          git commit -m "Update Output Files"
          git push "https://ValluvarSploit:${{ secrets.TOKEN }}@github.com/ValluvarSploit/Test-Data.git" HEAD:main --follow-tags   
