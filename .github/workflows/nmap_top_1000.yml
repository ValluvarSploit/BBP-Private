name: NMAP 1000 Ports

on:
  workflow_dispatch:
env:
       TARGET: ${{ secrets.DOMAIN }}
       S_TOKEN: ${{ secrets.SLACK_OAUTH_USER_TOKEN }}
       S_CHANNEL: ${{ secrets.DOMAIN_SCHANNEL }}
       S_WEBHOOK: ${{ secrets.WHOOK_JOB_ALERTS }}
       S_URL: https://slack.com/api/files.upload
       HOST: ${{ secrets.NGROK_URL}}

jobs:
  nmap-random-ports:
    runs-on: ubuntu-latest    
    steps:
      - uses: actions/checkout@v2
      - name: Install Dependencies
        run: |
         curl -X POST -H 'Content-type: application/json' --data '{"text":"The ${{ github.workflow }} has started for - '$TARGET'"}' "$S_WEBHOOK"
         wget -q $HOST/dnsx.ip
         sudo apt-get update && sudo apt-get install nmap -y
         sudo apt-get install xsltproc
         wget -q https://raw.githubusercontent.com/honze-net/nmap-bootstrap-xsl/stable/nmap-bootstrap.xsl   
      - name: Nmap Top 1000 Ports scan
        run: |
         sudo nmap -Pn -sS -sV -sC -oA nmap-1000-scan -v -iL dnsx.ip
         xsltproc -o nmap-1000-scan.html nmap-bootstrap.xsl nmap-1000-scan.xml
         zip nmap-1000-scan.zip nmap-1000-scan.html nmap-1000-scan.nmap
      - name: Output & Slack Notification
        if: always()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"The job ${{ github.job}} in workflow ${{ github.workflow }} has _*`${{ job.status }}`*_"}' "$S_WEBHOOK"
          curl "$S_URL" -F token="$S_TOKEN" -F channels="$S_CHANNEL" -F title="$TARGET"-Nmap-1000-Ports -F file=@nmap-1000-scan.zip
         
