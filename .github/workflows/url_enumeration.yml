name: URL Enumeration Workflow
on:
  workflow_dispatch:
env:
      TARGET: ${{ secrets.DOMAIN }}
      HOST: ${{ secrets.NGROK_URL }}
      S_TOKEN: ${{ secrets.SLACK_OAUTH_USER_TOKEN }}
      S_WEBHOOK: ${{ secrets.WHOOK_JOB_ALERTS }}
      S_URL: https://slack.com/api/files.upload
jobs:
  url-enumeration-jobs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Dependencies
        run: |
         go env -w GOPATH=~/Downloads ;
         go get -u github.com/tomnomnom/waybackurls;
         go get -u github.com/1ndianl33t/urlprobe;
         go get -u github.com/tomnomnom/gf;
         go get -u github.com/lc/gau;
         mkdir ~/.gf; cp -r ~/Downloads/src/github.com/tomnomnom/gf/examples ~/.gf ;
         git clone https://github.com/1ndianl33t/Gf-Patterns ;
         mv Gf-Patterns/*.json ~/.gf ;
         cp ~/Downloads/bin/gf .; cp ~/Downloads/bin/waybackurls .; cp ~/Downloads/bin/urlprobe .; cp ~/Downloads/bin/gau .;
      - name: waybackurls & gau
        run: |
         ./waybackurls "$TARGET" > waybackurls.txt  ;
         ./gau "$TARGET" > gau.txt ;
         cat gau.txt >> waybackurls.txt ;
         sort -u waybackurls.txt -o waybackurls.txt
      - name: Patterns
        run: |
         mkdir url-collector-artifacts
         cp waybackurls.txt url-collector-artifacts/
         cat waybackurls.txt | ./gf ssrf | sort -u > url-collector-artifacts/ssrf-params.txt ;
         cat waybackurls.txt | ./gf sqli | sort -u > url-collector-artifacts/sqli-params.txt ;
         cat waybackurls.txt | ./gf ssti | sort -u > url-collector-artifacts/ssti-params.txt ;
         cat waybackurls.txt | ./gf xss | sort -u > url-collector-artifacts/xss-params.txt ;
         cat waybackurls.txt | ./gf lfi | sort -u > url-collector-artifacts/lfi-params.txt ;
         cat waybackurls.txt | ./gf rce | sort -u > url-collector-artifacts/rce-params.txt ;
         cat waybackurls.txt | ./gf redirect | sort -u > url-collector-artifacts/redirect-params.txt ;
         cat waybackurls.txt | ./gf img-traversal | sort -u > url-collector-artifacts/img-traversal.txt ;
         cat waybackurls.txt | ./urlprobe -c 1000 -t 10 | grep 200 | awk '{print $5}' | tee -a urlprobe-sc-200.txt
         cp urlprobe-sc-200.txt url-collector-artifacts/
         zip -r url-collector-artifacts.zip url-collector-artifacts/ ; xz url-collector-artifacts.zip ;
      - name: Upload URL Collector Artifacts
        uses: actions/upload-artifact@v2
        with:
         name: url-collector-artifacts
         path: url-collector-artifacts/
      - name: Output & Slack Notification
        if: always()
        run: |
          S_CHANNEL=$(echo $TARGET | sed 's/\./_/g')
          curl "$S_URL" -F token="$S_TOKEN" -F channels="$S_CHANNEL" -F title="$TARGET"-Pattern-Collector -F file=@url-collector-artifacts.zip.xz ;
          curl -X POST -H 'Content-type: application/json' --data '{"text":"The job ${{ github.job}} in workflow ${{ github.workflow }} has _*`${{ job.status }}`*_  - '$TARGET'"}' "$S_WEBHOOK" ;
